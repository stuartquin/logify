// Generated by CoffeeScript 1.3.3
(function() {
  var Filters, LogLine, LogPanel,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Filters = (function() {

    function Filters() {
      var field,
        _this = this;
      this.active_filter = "";
      this.json_enabled = true;
      this.sql_enabled = true;
      field = $("#filter_field");
      field.keypress(function(evt) {
        if (evt.charCode === 13) {
          return _this.active_filter = field.val();
        }
      });
      $("#sql_toggle").button("toggle");
      $("#json_toggle").button("toggle");
      $("#sql_toggle").click(function(e) {
        e.stopImmediatePropagation();
        $("#sql_toggle").toggleClass("active");
        return _this.sql_enabled = !_this.sql_enabled;
      });
      $("#json_toggle").click(function(e) {
        e.stopImmediatePropagation();
        $("#json_toggle").toggleClass("active");
        return _this.json_enabled = !_this.json_enabled;
      });
    }

    return Filters;

  })();

  LogLine = (function() {

    LogLine.label_map = {
      error: "important",
      debug: "info",
      warn: "warning"
    };

    function LogLine(line, filters) {
      this.line = line;
      this.filters = filters;
      this.highlight_filter = __bind(this.highlight_filter, this);

      this.highlight_sql = __bind(this.highlight_sql, this);

      this.highlight_json = __bind(this.highlight_json, this);

      this.highlight_http_code = __bind(this.highlight_http_code, this);

      this.highlight_type = __bind(this.highlight_type, this);

      this.active_filter = this.filters.active_filter;
      this.format_json = this.filters.json_enabled;
      this.format_sql = this.filters.sql_enabled;
      this.line_class = "";
    }

    LogLine.prototype.highlight_type = function() {
      return this.line = this.line.replace(/(DEBUG|WARNING|WARN|INFO|ERROR)/i, function(match, group1) {
        var label;
        label = group1.toLowerCase();
        label = LogLine.label_map[label] || label;
        return "<strong class='label label-" + label + "'>" + match + "</strong>";
      });
    };

    LogLine.prototype.highlight_http_code = function() {
      return this.line = this.line.replace(/GET|POST|PUT|DELETE/, function(match) {
        return "<strong>" + match + "</strong>";
      });
    };

    LogLine.prototype.highlight_json = function() {
      return this.line = this.line.replace(/({(?:.*):(?:.*)})/gi, function(match) {
        var converted;
        try {
          converted = JSON.parse(match);
        } catch (error) {
          converted = match;
          console.log(error);
        }
        converted = JSON.stringify(converted, void 0, 2);
        return "<pre><code class='json'>" + converted + "</code></pre>";
      });
    };

    LogLine.prototype.highlight_sql = function() {
      this.line = this.line.replace(/(SELECT .+ FROM .+(WHERE)?)/gi, function(match) {
        return "<pre><code class='sql'>" + match + "</code></pre>";
      });
      this.line = this.line.replace(/\\n/gi, "<br />");
      return this.line = this.line.replace(/\\t/gi, "  ");
    };

    LogLine.prototype.highlight_filter = function() {
      if (this.active_filter === "") {
        return;
      }
      if (this.line.match(this.active_filter)) {
        this.line = this.line.replace(new RegExp(this.active_filter, "gi"), function(match) {
          return "<strong class='text-success'>" + match + "</strong>";
        });
        return this.line_class = "filtered";
      } else {
        return this.line_class = "muted-line";
      }
    };

    LogLine.prototype.render = function(index, callback) {
      var output;
      this.highlight_type();
      this.highlight_http_code();
      this.highlight_filter();
      if (this.format_json) {
        this.highlight_json();
      }
      if (this.format_sql) {
        this.highlight_sql();
      }
      if (index % 2 !== 0) {
        this.line_class += " striped";
      }
      output = $("<div class='line " + this.line_class + "'>");
      output.html(this.line);
      return callback(output);
    };

    return LogLine;

  })();

  LogPanel = (function() {

    LogPanel.label_map = {
      error: "important",
      debug: "info"
    };

    function LogPanel(id, filters) {
      this.id = id;
      this.filters = filters;
      this.panel_el = $(this.id);
      this.line_count = 0;
      this.max_lines = 1000;
    }

    LogPanel.prototype.add_line = function(data) {
      var logLine,
        _this = this;
      logLine = new LogLine(data, this.filters);
      return logLine.render(this.line_count, function(formatted) {
        _this.panel_el.prepend(formatted);
        formatted.find("pre code").each(function(i, e) {
          return hljs.highlightBlock(e);
        });
        _this.line_count++;
        if (_this.line_count > _this.max_lines) {
          return _this.panel_el.find("div:last-child").remove();
        }
      });
    };

    LogPanel.prototype.clear = function() {
      this.line_count = 0;
      return this.panel_el.html("");
    };

    return LogPanel;

  })();

  $(document).ready(function() {
    var all_lines, filters, logs_paused, socket,
      _this = this;
    socket = io.connect();
    filters = new Filters();
    all_lines = new LogPanel("#log_output", filters);
    logs_paused = false;
    $("#clear_logs").click(function() {
      return all_lines.clear();
    });
    $("#pause_logs").click(function() {
      $("#pause_logs").find("i").toggleClass("icon-pause").toggleClass("icon-play");
      $("#pause_logs").toggleClass("btn-success");
      return logs_paused = !logs_paused;
    });
    return socket.on("log", function(data) {
      if (!logs_paused) {
        return all_lines.add_line(data);
      }
    });
  });

}).call(this);
